/*! Ciao.Cms 1.0.0 14-12-2016 01:12:16 */
var app=angular.module("App",["angular-jwt","ngMaterial","ui.router","md.data.table","angularFileUpload","LocalStorageModule","textAngular","slickCarousel","ui.sortable"]).config(["$urlRouterProvider","jwtInterceptorProvider","$httpProvider","$locationProvider","jwtOptionsProvider","localStorageServiceProvider","$mdThemingProvider",function(a,b,c,d,e,f,g){a.otherwise("/blog"),f.setPrefix("vinarija_djordjevic"),b.tokenGetter=function(a){return a.get("token")},e.config({tokenGetter:function(a){return a.getItem("token")},whiteListedDomains:["localhost","cms.vinarijadjordje.rs","enginee.rs"],unauthenticatedRedirectPath:"/login"}),c.interceptors.push("jwtInterceptor"),c.interceptors.push(["$injector","$q","localStorageService","$rootScope",function(a,b,c,d){return{responseError:function(e){var f=a.get("config"),g=a.get("$http");return 401!=e.status&&403!=e.status||!e.config.url.startsWith(f.baseAddress)||e.data.message.toLowerCase().indexOf("token")==-1||(c.remove("token"),delete g.defaults.headers.common.Authorization,d.session={},$state.go("login")),b.reject(e)}}}]),d.html5Mode(!0),g.theme("default").primaryPalette("blue").accentPalette("red")}]).run(["$rootScope","$state","jwtHelper","$mdToast","localStorageService",function(a,b,c,d,e){a.$on("$stateChangeStart",function(d,f){f.data&&f.data.requiresLogin?e.get("token")&&!c.isTokenExpired(e.get("token"))||(d.preventDefault(),b.go("login")):e.get("token")&&"login"==f.name&&(d.preventDefault(),b.go("layout.blog")),a.session=e.get("token")?c.decodeToken(e.get("token")):{}}),a.$on("toast",function(a,b){b&&b.message&&d.show(d.simple().content(b.message).hideDelay(b.duration?b.duration:2e3))})}]);app.constant("config",{baseAddress:"http://localhost:53491/api/",postImagesPath:"http://localhost:53491/Content/Posts/",galleryImagesPath:"http://localhost:53491/Content/Gallery/"}),app.filter("correctedDate",function(){return function(a){if(a)return moment.utc(a).local().format("MM/DD/YYYY")}}),app.config(["$stateProvider",function(a){a.state("layout.blog",{url:"/blog",controller:"BlogController",templateUrl:"app/sections/blog/blog.html",data:{requiresLogin:!0}})}]).controller("BlogController",["$scope","blogService","$timeout","$mdDialog",function(a,b,c,d){function e(){return a.loading=!0,a.promise=b.get(a.params).then(function(b){a.posts=b.posts,a.totalItems=b.totalCount,a.loading=!1},function(){a.loading=!1}),a.promise}a.params={pageSize:10,pageNumber:1,orderBy:"-date"},e(),a.onPaginate=function(b,c){a.params.pageNumber=b,a.params.pageSize=c,e()},a.onReorder=function(b){a.params.sort=b,e()},a.openModal=function(a,b){d.show({controller:"PostModalController",templateUrl:"app/sections/blog/modals/postModal.html",parent:angular.element(document.body),targetEvent:a,size:"lg",clickOutsideToClose:!0,locals:{post:angular.copy(b)}}).then(function(a){e()},function(){})},a.removeModal=function(c,f){var g=d.confirm().title("Brisanje posta").textContent("Da li ste sigurni da želite da obrišete post?").ariaLabel("Brisanje").targetEvent(c).ok("Da").cancel("Ne");d.show(g).then(function(){b.remove(f.id).then(function(b){a.params.pageNumber=1,e()})})},a.toggleActive=function(a){b.activateDeactivate(a)};var f;a.search=function(){f&&c.cancel(f),f=c(function(){e()},250)}}]),app.controller("PostModalController",["$scope","$mdDialog","blogService","post","FileUploader","config","localStorageService","taOptions",function(a,b,c,d,e,f,g,h){h.toolbar=[["h1","h2","h3","h4","h5","h6","p","pre","quote"],["bold","italics","underline","strikeThrough","ul","ol","redo","undo","clear"],["justifyLeft","justifyCenter","justifyRight","indent","outdent"]],a.imagePath=f.postImagesPath,a.uploader=new e({url:f.baseAddress+"post/uploadImage",headers:{Authorization:g.get("token")}}),a.uploader.filters.push({name:"imageFilter",fn:function(a,b){var c="|"+a.type.slice(a.type.lastIndexOf("/")+1)+"|";return"|jpg|png|jpeg|bmp|gif|".indexOf(c)!==-1}}),a.uploader.onAfterAddingFile=function(){a.uploader.queue.length>1&&a.uploader.queue.splice(0,1)},a.uploader.onBeforeUploadItem=function(b){b.formData.push({id:a.post.id})},a.uploader.onCompleteAll=function(){a.loading=!1,b.hide(a.response)},a.post=d,a.post&&(a.post.date=new Date(d.date)),a.store=function(){a.loading=!0;var d=a.post.id?c.update(a.post):c.add(a.post);d.then(function(c){a.response=c,a.$emit("toast",{message:"Uspešno sačuvano!",type:"success"}),a.uploader.queue&&a.uploader.queue.length?(a.post.id=c.id,a.uploader.uploadAll()):b.hide(a.response)})},a.removeImage=function(b){c.removeImage(a.post.id,b).then(function(b){a.post.postImages=[],a.$emit("toast",{message:"Slika uspešno obrisana!",type:"success"})})},a.cancel=function(){b.cancel()}}]),app.config(["$stateProvider",function(a){a.state("layout.gallery",{url:"/gallery",controller:"GalleryController",templateUrl:"app/sections/gallery/gallery.html",data:{requiresLogin:!0}})}]).controller("GalleryController",["$scope","galleryService","$timeout","$mdDialog","FileUploader","config","localStorageService",function(a,b,c,d,e,f,g){function h(){return a.loading=!0,a.refreshSlick=!0,a.promise=b.getImages().then(function(b){_.each(b,function(a){a.name=a.filePath.substring(a.filePath.indexOf("_")+1),a.filePath=f.galleryImagesPath+a.filePath}),a.galleryImages=b,a.oldGallery=angular.copy(a.galleryImages),a.loading=!1,a.refreshSlick=!1,a.reordering=!1},function(){a.loading=!1}),a.promise}a.oldGallery=[],a.slickConfig={enabled:!0,draggable:!0,autoplaySpeed:3e3,method:{}},a.uploader=new e({url:f.baseAddress+"gallery/uploadImage",headers:{Authorization:g.get("token")}}),a.uploader.filters.push({name:"imageFilter",fn:function(a,b){var c="|"+a.type.slice(a.type.lastIndexOf("/")+1)+"|";return"|jpg|png|jpeg|bmp|gif|".indexOf(c)!==-1}}),a.uploader.onAfterAddingFile=function(b){a.uploadingImages=!0},a.uploader.onCompleteAll=function(){a.uploadingImages=!1,a.uploader.queue=[],h()},a.sortableOptions={update:function(b,c){a.reordering=!0},start:function(b,c){a.refreshSlick=!0,a.$apply()},stop:function(b,c){a.refreshSlick=!1,a.$apply()},axis:"y",helper:function(a,b){return b.children().each(function(){$(this).width($(this).width())}),b},handle:".fa-bars"},h(),a.removeImage=function(c,e){var f=d.confirm().title("Brisanje slike").textContent("Da li ste sigurni da želite da obrišete sliku?").ariaLabel("Brisanje").targetEvent(c).ok("Da").cancel("Ne");d.show(f).then(function(){b.removeImage(e.id).then(function(){h(),a.$emit("toast",{message:"Slika uspešno obrisana!",type:"success"})})})},a.cancelUpload=function(){a.uploader.queue=[],a.uploadingImages=!1},a.uploadImages=function(){a.uploader.uploadAll()},a.cancelReordering=function(){a.galleryImages=angular.copy(a.oldGallery),a.reordering=!1,a.refreshSlick=!0,c(function(){a.refreshSlick=!1},0)},a.saveReordering=function(){b.saveReorder(a.galleryImages).then(function(){h()})},a.openImagePreviewModal=function(a,b){d.show({controller:"ImagePreviewModalController",templateUrl:"app/sections/gallery/modals/imagePreviewModal.html",parent:angular.element(document.body),targetEvent:a,size:"lg",clickOutsideToClose:!0,locals:{image:angular.copy(b)}})}}]),app.controller("ImagePreviewModalController",["$scope","$mdDialog","config","image","$timeout",function(a,b,c,d,e){a.image=d,a.cancel=function(){b.cancel()}}]),app.config(["$stateProvider",function(a){a.state("layout",{controller:"LayoutController",templateUrl:"app/sections/layout/layout.html",data:{requiresLogin:!0}})}]).controller("LayoutController",["$rootScope","$scope","$http","$state","$mdSidenav","localStorageService",function(a,b,c,d,e,f){b.close=function(){e("left").close()},b.toggle=function(){e("left").toggle()},b.logout=function(){f.remove("token"),delete c.defaults.headers.common.access_token,a.session={},d.go("login")}}]),app.config(["$stateProvider",function(a){a.state("login",{url:"/login",controller:"LoginController",templateUrl:"app/sections/login/login.html"})}]).controller("LoginController",["$scope","$state","adminService","localStorageService",function(a,b,c,d){a.user={},a.login=function(){c.login(a.user).then(function(a){d.set("token",a.token),b.go("layout.blog")})}}]),app.factory("adminService",["$http","config","$rootScope","$q",function(a,b,c,d){var e={};return e.login=function(e){return a({url:b.baseAddress+"user/login",method:"POST",data:e}).then(function(a){return a.data},function(a){return c.$emit("toast",{message:a.data.message}),d.reject(a)})},e}]),app.factory("blogService",["$http","config","$rootScope",function(a,b,c){var d={};return d.get=function(d){return a({url:b.baseAddress+"post/getAll",method:"GET",params:d}).then(function(a){return a.data},function(a){throw c.$emit("toast",{message:a.data.message,type:"danger"}),"blogService.get: "+a.data.message})},d.add=function(d){return a({url:b.baseAddress+"post/add",method:"POST",data:d}).then(function(a){return a.data},function(a){throw c.$emit("toast",{message:a.data.message,type:"danger"}),"blogService.add: "+a.data.message})},d.update=function(d){return a({url:b.baseAddress+"post/update",method:"PUT",data:d}).then(function(a){return a.data},function(a){throw c.$emit("toast",{message:a.data.message,type:"danger"}),"blogService.update: "+a.data.message})},d.activateDeactivate=function(d){return a({url:b.baseAddress+"post/activeDeactive",method:"PUT",data:{postId:d.id,active:d.active}}).then(function(a){return a.data},function(a){throw c.$emit("toast",{message:a.data.message,type:"danger"}),"blogService.update: "+a.data.message})},d.remove=function(d){return a({url:b.baseAddress+"post/delete",method:"DELETE",params:{postId:d}}).then(function(a){return a.data},function(a){throw c.$emit("toast",{message:a.data.message,type:"danger"}),"blogService.remove: "+a.data.message})},d.removeImage=function(d,e){return a({url:b.baseAddress+"post/removeImage",method:"PUT",data:{postId:d,postImageId:e.id}}).then(function(a){return a.data},function(a){throw c.$emit("toast",{message:a.data.message,type:"danger"}),"blogService.remove: "+a.data.message})},d}]),app.factory("galleryService",["$http","config","$rootScope","$q",function(a,b,c,d){var e={};return e.getImages=function(e){return a({url:b.baseAddress+"gallery/getAll",method:"GET",params:e}).then(function(a){return a.data},function(a){return c.$emit("toast",{message:a.data.message}),d.reject(a)})},e.removeImage=function(e){return a({url:b.baseAddress+"gallery/removeImage",method:"DELETE",params:{imageId:e}}).then(function(a){return a.data},function(a){return c.$emit("toast",{message:a.data.message}),d.reject(a)})},e.saveReorder=function(e){var f=e.map(function(a){return a.id});return f.reverse(),a({url:b.baseAddress+"gallery/reorder",method:"PUT",data:{galleryIds:f}}).then(function(a){return a.data},function(a){return c.$emit("toast",{message:a.data.message}),d.reject(a)})},e}]);